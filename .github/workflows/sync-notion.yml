name: Sync Notion Data

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Fetch Notion data
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');
          
          const apiKey = process.env.NOTION_API_KEY;
          const databaseId = process.env.NOTION_DATABASE_ID;
          
          if (!apiKey || !databaseId) {
            console.error('Missing environment variables');
            process.exit(1);
          }
          
          console.log('Fetching from Notion Injection Tracker...');
          
          const options = {
            hostname: 'api.notion.com',
            port: 443,
            path: `/v1/databases/${databaseId}/query`,
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Notion-Version': '2025-09-03',
              'Content-Type': 'application/json'
            }
          };
          
          const postData = JSON.stringify({
            page_size: 100
          });
          
          const req = https.request(options, (res) => {
            let data = '';
            
            res.on('data', (chunk) => {
              data += chunk;
            });
            
            res.on('end', () => {
              if (res.statusCode !== 200) {
                console.error(`Error: ${res.statusCode}`);
                console.error(data);
                process.exit(1);
              }
              
              const response = JSON.parse(data);
              console.log(`Fetched ${response.results.length} pages`);
              
              // Process the data
              const samples = [];
              const pickLists = {};
              
              response.results.forEach(page => {
                const props = page.properties;
                
                // Get Injection ID (title property)
                let injectionId = '';
                if (props['Injection ID'] && props['Injection ID'].title && props['Injection ID'].title[0]) {
                  injectionId = props['Injection ID'].title[0].plain_text;
                }
                
                if (!injectionId) {
                  return; // Skip if no ID
                }
                
                // Get Experiment Description
                let description = '';
                if (props['Experiment Description - Manual'] && props['Experiment Description - Manual'].rich_text && props['Experiment Description - Manual'].rich_text[0]) {
                  description = props['Experiment Description - Manual'].rich_text[0].plain_text;
                }
                
                // Get Location
                let location = '';
                if (props['Location'] && props['Location'].rich_text && props['Location'].rich_text[0]) {
                  location = props['Location'].rich_text[0].plain_text;
                }
                
                // Get Reserved Status (multi-select, take first)
                let reserved = 'Available';
                if (props['Reserved'] && props['Reserved'].multi_select && props['Reserved'].multi_select[0]) {
                  reserved = props['Reserved'].multi_select[0].name;
                }
                
                // Get Sectioning Date
                let sectioningDate = '';
                if (props['date:Sectioning Date:start'] && props['date:Sectioning Date:start'].date) {
                  sectioningDate = props['date:Sectioning Date:start'].date.start;
                }
                
                // Get Pick List (multi-select) ← THE KEY FEATURE!
                let pickList = [];
                if (props['Pick List'] && props['Pick List'].multi_select) {
                  pickList = props['Pick List'].multi_select.map(item => item.name);
                }
                
                // Store pick list separately for easy access
                if (pickList.length > 0) {
                  pickLists[injectionId] = pickList;
                }
                
                // Create sample object
                samples.push({
                  injectionId: injectionId,
                  experimentDescription: description,
                  reservedStatus: reserved,
                  location: location,
                  sectioningDate: sectioningDate,
                  status: 'in_place',
                  checkedOutBy: null,
                  checkedOutTime: null
                });
              });
              
              // Save to file
              const output = {
                samples: samples,
                pickLists: pickLists,
                lastSync: new Date().toISOString(),
                totalSamples: samples.length,
                totalWithPickLists: Object.keys(pickLists).length
              };
              
              fs.writeFileSync('notion-data.json', JSON.stringify(output, null, 2));
              console.log(`✓ Saved ${samples.length} samples`);
              console.log(`✓ Saved ${Object.keys(pickLists).length} pick lists`);
              console.log(`✓ Last sync: ${output.lastSync}`);
              
              // Also save just the samples for backup
              fs.writeFileSync('notion-samples-backup.json', JSON.stringify({samples: samples}, null, 2));
            });
          });
          
          req.on('error', (error) => {
            console.error('Request error:', error);
            process.exit(1);
          });
          
          req.write(postData);
          req.end();
          EOF
          
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add notion-data.json notion-samples-backup.json
          git diff --staged --quiet || git commit -m "Update Notion data - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
  
