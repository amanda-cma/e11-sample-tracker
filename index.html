<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E11 Sample Tracker - Fresh Start</title>
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;background-color: #f5f5f5;padding-bottom: 60px;}
        header {background-color: #2563eb;color: white;padding: 16px;position: sticky;top: 0;z-index: 100;box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .header-content {max-width: 1200px;margin: 0 auto;display: flex;justify-content: space-between;align-items: center;}
        h1 {font-size: 24px;font-weight: bold;}
        .nav-buttons {display: flex;gap: 8px;}
        .nav-btn {padding: 8px 16px;border: none;border-radius: 4px;background-color: #3b82f6;color: white;cursor: pointer;font-size: 14px;}
        .nav-btn:hover {background-color: #1d4ed8;}
        .nav-btn.active {background-color: #1e40af;}
        .container {max-width: 1200px;margin: 0 auto;padding: 24px 16px;}
        .search-box {width: 100%;padding: 16px 24px;font-size: 18px;border: 2px solid #d1d5db;border-radius: 8px;margin-bottom: 24px;}
        .search-box:focus {outline: none;border-color: #2563eb;}
        
        /* Pick List Highlighting */
        .sample-card {background: white;border: 2px solid #e5e7eb;border-radius: 8px;padding: 16px;margin-bottom: 12px;cursor: pointer;transition: all 0.2s;}
        .sample-card:hover {border-color: #3b82f6;box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .sample-card.my-pick {border: 3px solid #fbbf24;background: #fffbeb;box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);}
        .sample-card.team-pick {border: 3px solid #60a5fa;background: #eff6ff;box-shadow: 0 0 10px rgba(96, 165, 250, 0.3);}
        
        .sample-header {display: flex;align-items: center;gap: 12px;margin-bottom: 8px;}
        .sample-id {font-size: 20px;font-weight: bold;color: #111827;}
        .status-dot {width: 12px;height: 12px;border-radius: 50%;}
        .status-in-place {background-color: #10b981;}
        .status-checked-out {background-color: #f59e0b;}
        .sample-description {color: #6b7280;font-size: 14px;margin-bottom: 8px;}
        .sample-location {font-family: monospace;color: #2563eb;font-weight: bold;font-size: 14px;}
        .badge {display: inline-block;padding: 4px 8px;border-radius: 4px;font-size: 12px;margin-left: 8px;}
        .badge-reserved {background-color: #dbeafe;color: #1e40af;}
        .badge-pick {background-color: #fef3c7;color: #92400e;font-weight: bold;}
        
        /* Filter Bar */
        .filter-bar {display: flex;gap: 8px;margin-bottom: 16px;flex-wrap: wrap;align-items: center;}
        .filter-btn {padding: 10px 16px;border: 2px solid #d1d5db;border-radius: 6px;background: white;cursor: pointer;font-size: 14px;font-weight: 500;transition: all 0.2s;}
        .filter-btn:hover {border-color: #3b82f6;}
        .filter-btn.active {border-color: #2563eb;background: #eff6ff;color: #2563eb;}
        .sync-status {margin-left: auto;font-size: 12px;color: #6b7280;display: flex;align-items: center;gap: 6px;}
        .sync-dot {width: 8px;height: 8px;border-radius: 50%;background: #10b981;animation: pulse 2s infinite;}
        .sync-dot.error {background: #ef4444;}
        .sync-dot.inactive {background: #9ca3af;}
        @keyframes pulse {0%, 100% {opacity: 1;} 50% {opacity: 0.5;}}
        
        .shelf-selector {display: grid;grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));gap: 12px;margin-bottom: 24px;}
        .shelf-btn {padding: 20px;background: white;border: 3px solid #e5e7eb;border-radius: 8px;cursor: pointer;transition: all 0.2s;text-align: center;}
        .shelf-btn:hover {border-color: #3b82f6;}
        .shelf-label {font-size: 24px;font-weight: bold;color: #374151;margin-bottom: 8px;}
        .shelf-count {font-size: 14px;color: #6b7280;}
        .rack-view,.drawer-view,.compartment-view {background: white;border-radius: 12px;padding: 20px;box-shadow: 0 2px 8px rgba(0,0,0,0.1);margin-top: 16px;}
        .rack-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));gap: 12px;margin-top: 16px;}
        .rack-card {background: #f9fafb;border: 2px solid #d1d5db;border-radius: 8px;padding: 16px 12px;cursor: pointer;transition: all 0.2s;text-align: center;}
        .rack-card:hover {border-color: #3b82f6;background: #eff6ff;}
        .rack-number {font-size: 20px;font-weight: bold;color: #374151;margin-bottom: 4px;}
        .rack-samples {font-size: 12px;color: #6b7280;}
        .drawer-stack {display: flex;flex-direction: column;gap: 8px;margin-top: 16px;}
        .drawer-row {background: #f3f4f6;border: 2px solid #d1d5db;border-radius: 8px;padding: 12px;cursor: pointer;transition: all 0.2s;display: flex;justify-content: space-between;align-items: center;}
        .drawer-row:hover {border-color: #3b82f6;background: #eff6ff;}
        .drawer-label {font-weight: bold;color: #374151;}
        .drawer-count {font-size: 14px;color: #6b7280;}
        .compartment-grid {display: grid;grid-template-columns: repeat(5, 1fr);gap: 12px;margin-top: 16px;}
        @media (max-width: 768px) {.compartment-grid {grid-template-columns: repeat(3, 1fr);}}
        .compartment-box {background: #f9fafb;border: 2px solid #d1d5db;border-radius: 8px;padding: 12px 8px;min-height: 120px;display: flex;flex-direction: column;gap: 6px;}
        .compartment-label {font-size: 12px;font-weight: bold;color: #6b7280;text-align: center;margin-bottom: 4px;}
        
        /* Position slot highlighting */
        .position-slot {background: #e5e7eb;border: 1px solid #9ca3af;border-radius: 4px;padding: 8px 4px;font-size: 11px;text-align: center;cursor: pointer;transition: all 0.2s;word-break: break-word;}
        .position-slot:hover {background: #d1d5db;}
        .position-slot.filled {background: #10b981;color: white;font-weight: bold;border-color: #059669;}
        .position-slot.checked-out {background: #f59e0b;color: white;font-weight: bold;border-color: #d97706;}
        .position-slot.reserved {background: #3b82f6;color: white;font-weight: bold;border-color: #2563eb;}
        .position-slot.my-pick {background: #fbbf24;color: #78350f;font-weight: bold;border: 2px solid #f59e0b;box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);}
        .position-slot.team-pick {background: #60a5fa;color: white;font-weight: bold;border: 2px solid #3b82f6;}
        
        .breadcrumb {display: flex;gap: 8px;align-items: center;margin-bottom: 16px;flex-wrap: wrap;}
        .breadcrumb-item {color: #6b7280;font-size: 14px;}
        .breadcrumb-separator {color: #9ca3af;}
        .breadcrumb-link {color: #2563eb;cursor: pointer;text-decoration: underline;}
        .breadcrumb-link:hover {color: #1d4ed8;}
        .hidden {display: none;}
        footer {position: fixed;bottom: 0;width: 100%;background: white;border-top: 1px solid #e5e7eb;padding: 12px;text-align: center;font-size: 14px;color: #6b7280;}
        .btn {width: 100%;padding: 12px;border: none;border-radius: 4px;font-size: 16px;font-weight: bold;cursor: pointer;margin-bottom: 8px;}
        .btn-primary {background-color: #2563eb;color: white;}
        .btn-primary:hover {background-color: #1d4ed8;}
        .btn-success {background-color: #10b981;color: white;}
        .btn-success:hover {background-color: #059669;}
        .btn-warning {background-color: #f59e0b;color: white;}
        .btn-warning:hover {background-color: #d97706;}
        .btn-danger {background-color: #ef4444;color: white;}
        .btn-danger:hover {background-color: #dc2626;}
        .detail-view {background: white;border-radius: 8px;padding: 32px;box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .back-btn {color: #2563eb;text-decoration: none;display: inline-block;margin-bottom: 24px;cursor: pointer;}
        .detail-grid {display: grid;grid-template-columns: 1fr 1fr;gap: 32px;}
        @media (max-width: 768px) {.detail-grid {grid-template-columns: 1fr;}}
        .info-section {margin-bottom: 16px;}
        .info-label {font-size: 12px;color: #6b7280;margin-bottom: 4px;}
        .info-value {font-size: 16px;color: #111827;}
        .location-box {background-color: #f9fafb;padding: 24px;border-radius: 8px;margin-bottom: 24px;}
        .location-display {font-family: monospace;font-size: 32px;font-weight: bold;color: #2563eb;margin-bottom: 16px;}
        input[type="text"],input[type="date"],input[type="password"],select,textarea {width: 100%;padding: 8px 12px;border: 1px solid #d1d5db;border-radius: 4px;margin-bottom: 8px;font-size: 14px;}
        input:focus,select:focus,textarea:focus {outline: none;border-color: #2563eb;}
        .admin-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));gap: 12px;margin-bottom: 24px;}
        .form-group {margin-bottom: 16px;}
        label {display: block;font-size: 14px;font-weight: 500;margin-bottom: 4px;}
        .stats-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));gap: 16px;}
        .stat-card {background-color: #f9fafb;padding: 16px;border-radius: 8px;text-align: center;}
        .stat-number {font-size: 32px;font-weight: bold;color: #2563eb;}
        .stat-label {font-size: 14px;color: #6b7280;}
        
        /* Setup Modal */
        .modal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,0.5);z-index: 1000;align-items: center;justify-content: center;}
        .modal.active {display: flex;}
        .modal-content {background: white;border-radius: 12px;padding: 32px;max-width: 500px;width: 90%;max-height: 90vh;overflow-y: auto;}
        .modal-header {font-size: 24px;font-weight: bold;margin-bottom: 16px;}
        .user-grid {display: grid;grid-template-columns: repeat(2, 1fr);gap: 12px;margin-top: 16px;}
        .user-btn {padding: 16px;border: 2px solid #d1d5db;border-radius: 8px;background: white;cursor: pointer;font-size: 16px;font-weight: 500;transition: all 0.2s;}
        .user-btn:hover {border-color: #3b82f6;background: #eff6ff;}
        .user-btn.selected {border-color: #2563eb;background: #dbeafe;color: #2563eb;}
        .help-text {font-size: 13px;color: #6b7280;margin-top: 4px;line-height: 1.4;}
        .status-message {padding: 12px;border-radius: 6px;margin-bottom: 16px;font-size: 14px;}
        .status-success {background: #d1fae5;color: #065f46;border: 1px solid #059669;}
        .status-error {background: #fee2e2;color: #991b1b;border: 1px solid #dc2626;}
        .status-info {background: #dbeafe;color: #1e40af;border: 1px solid #3b82f6;}
        .empty-state {text-align: center;padding: 64px 24px;color: #6b7280;}
        .empty-state h2 {font-size: 24px;margin-bottom: 12px;color: #374151;}
        .empty-state p {margin-bottom: 24px;}
        .debug-log {background: #1f2937;color: #10b981;padding: 12px;border-radius: 6px;font-family: monospace;font-size: 12px;max-height: 200px;overflow-y: auto;margin-top: 12px;}
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>E11 Sample Tracker</h1>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showView('search')">Search</button>
                <button class="nav-btn" onclick="showView('browse')">Browse</button>
                <button class="nav-btn" onclick="showView('admin')">‚öôÔ∏è</button>
            </div>
        </div>
    </header>
    <div class="container">
        <div id="searchView">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="setFilter('all')" id="filterAll">All Samples</button>
                <button class="filter-btn" onclick="setFilter('my-picks')" id="filterMyPicks">My Picks</button>
                <button class="filter-btn" onclick="setFilter('team-picks')" id="filterTeamPicks">Team Picks</button>
                <div class="sync-status">
                    <div class="sync-dot inactive" id="syncDot"></div>
                    <span id="syncStatus">Not configured</span>
                </div>
            </div>
            <input type="text" class="search-box" id="searchInput" placeholder="Search by Injection ID (e.g., i2102) or description..." oninput="filterSamples()">
            <div id="searchResults">
                <div class="empty-state">
                    <h2>No Samples Yet</h2>
                    <p>Import data from Notion or add samples manually in the Admin panel</p>
                </div>
            </div>
        </div>
        <div id="browseView" class="hidden">
            <div class="filter-bar">
                <button class="filter-btn active" onclick="setFilter('all')" id="filterAll2">All Samples</button>
                <button class="filter-btn" onclick="setFilter('my-picks')" id="filterMyPicks2">My Picks</button>
                <button class="filter-btn" onclick="setFilter('team-picks')" id="filterTeamPicks2">Team Picks</button>
                <div class="sync-status">
                    <div class="sync-dot inactive" id="syncDot2"></div>
                    <span id="syncStatus2">Not configured</span>
                </div>
            </div>
            <h2 style="margin-bottom: 24px; font-size: 24px;">Browse by Physical Location</h2>
            <div id="shelfSelector" class="shelf-selector"></div>
            <div id="rackView" class="hidden"></div>
            <div id="drawerView" class="hidden"></div>
            <div id="compartmentView" class="hidden"></div>
        </div>
        <div id="detailView" class="hidden"></div>
        <div id="adminView" class="hidden">
            <h2 style="margin-bottom: 24px; font-size: 24px;">Admin Panel</h2>
            
            <div style="background: white; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; font-size: 18px;">Notion Integration Setup</h3>
                <div id="notionStatus"></div>
                
                <div class="form-group">
                    <label>Current User</label>
                    <input type="text" id="currentUser" readonly style="background: #f3f4f6;">
                    <button class="btn btn-primary" onclick="changeUser()">Change User</button>
                </div>
                
                <div class="form-group">
                    <label>Notion API Key</label>
                    <input type="password" id="notionApiKey" placeholder="secret_...">
                    <div class="help-text">Get from: <a href="https://www.notion.so/my-integrations" target="_blank">notion.so/my-integrations</a></div>
                </div>
                
                <div class="form-group">
                    <label>Database ID</label>
                    <input type="text" id="notionDatabaseId" placeholder="e8c370d9e55847b08afc...">
                    <div class="help-text">From database URL (the part after last / and before ?)</div>
                </div>
                
                <div class="form-group">
                    <label>Database ID Format</label>
                    <select id="dbIdFormat" onchange="reformatDatabaseId()">
                        <option value="nodash">No dashes (e8c370d9e558...)</option>
                        <option value="dash">With dashes (e8c370d9-e558-...)</option>
                    </select>
                    <div class="help-text">Try both formats if connection fails</div>
                </div>
                
                <button class="btn btn-success" onclick="testNotionConnection()">Test Connection</button>
                <button class="btn btn-primary" onclick="saveNotionConfig()">Save & Start Sync</button>
                <button class="btn btn-warning" onclick="syncFromNotion()">Sync Now (Manual)</button>
                
                <div id="debugLog" class="debug-log hidden"></div>
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 24px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px; font-size: 18px;">Data Management</h3>
                <div class="admin-grid">
                    <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">Import Data</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
            </div>
            
            <div style="background: white; border-radius: 8px; padding: 24px;">
                <h3 style="margin-bottom: 16px; font-size: 18px;">Statistics</h3>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
        </div>
    </div>
    <footer><span id="footerStats">0 samples</span></footer>
    
    <!-- User Selection Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">Who are you?</div>
            <p style="color: #6b7280; margin-bottom: 16px;">Select your name to see personalized pick lists</p>
            <div class="user-grid">
                <button class="user-btn" onclick="selectUser('Jules')">Jules</button>
                <button class="user-btn" onclick="selectUser('Michelle')">Michelle</button>
                <button class="user-btn" onclick="selectUser('Kathleen')">Kathleen</button>
                <button class="user-btn" onclick="selectUser('Jeff')">Jeff</button>
                <button class="user-btn" onclick="selectUser('Hugo')">Hugo</button>
                <button class="user-btn" onclick="selectUser('Stephanie')">Stephanie</button>
                <button class="user-btn" onclick="selectUser('Amanda')">Amanda</button>
                <button class="user-btn" onclick="selectUser('Clarence')">Clarence</button>
            </div>
            <div class="form-group" style="margin-top: 16px;">
                <label>Or enter your name:</label>
                <input type="text" id="customUserName" placeholder="Your name">
                <button class="btn btn-primary" onclick="selectUser(document.getElementById('customUserName').value)">Continue</button>
            </div>
        </div>
    </div>

    <script>
// Storage keys
const STORAGE_KEY = 'e11_samples_v2';
const USER_KEY = 'e11_current_user_v2';
const NOTION_CONFIG_KEY = 'e11_notion_config_v2';
const NOTION_CACHE_KEY = 'e11_notion_cache_v2';

// State
let samples = [];
let currentView = 'search';
let currentUser = '';
let currentFilter = 'all';
let selectedShelf = null, selectedRack = null, selectedDrawer = null;
let notionConfig = null;
let notionCache = {};
let syncInterval = null;
let lastSyncTime = null;

// Debug logging
function debugLog(message, data = null) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `[${timestamp}] ${message}`;
    console.log(logMessage, data || '');
    
    const debugDiv = document.getElementById('debugLog');
    if (debugDiv) {
        debugDiv.classList.remove('hidden');
        debugDiv.innerHTML += logMessage + (data ? ': ' + JSON.stringify(data, null, 2) : '') + '\n';
        debugDiv.scrollTop = debugDiv.scrollHeight;
    }
}

// Initialize
function init() {
    debugLog('Initializing tracker...');
    loadSamples();
    loadNotionConfig();
    loadNotionCache();
    
    currentUser = localStorage.getItem(USER_KEY);
    if (!currentUser) {
        showUserModal();
    } else {
        document.getElementById('currentUser').value = currentUser;
    }
    
    renderView();
    
    if (notionConfig && notionConfig.apiKey && notionConfig.databaseId) {
        debugLog('Notion config found, starting auto-sync');
        startNotionSync();
    }
}

function showUserModal() {
    document.getElementById('userModal').classList.add('active');
}

function selectUser(name) {
    if (!name || !name.trim()) {
        alert('Please enter a name');
        return;
    }
    currentUser = name.trim();
    localStorage.setItem(USER_KEY, currentUser);
    document.getElementById('currentUser').value = currentUser;
    document.getElementById('userModal').classList.remove('active');
    debugLog('User selected: ' + currentUser);
    renderView();
}

function changeUser() {
    showUserModal();
}

function loadSamples() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
        samples = JSON.parse(stored);
        debugLog('Loaded samples from localStorage', {count: samples.length});
    } else {
        samples = [];
        debugLog('No samples in localStorage, starting fresh');
    }
}

function saveSamples() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(samples));
    updateFooter();
    debugLog('Saved samples to localStorage', {count: samples.length});
}

function loadNotionConfig() {
    const stored = localStorage.getItem(NOTION_CONFIG_KEY);
    if (stored) {
        notionConfig = JSON.parse(stored);
        if (notionConfig.apiKey) {
            document.getElementById('notionApiKey').value = notionConfig.apiKey;
        }
        if (notionConfig.databaseId) {
            document.getElementById('notionDatabaseId').value = notionConfig.databaseId;
        }
        debugLog('Loaded Notion config');
    }
}

function loadNotionCache() {
    const stored = localStorage.getItem(NOTION_CACHE_KEY);
    if (stored) {
        notionCache = JSON.parse(stored);
        debugLog('Loaded Notion cache', {entries: Object.keys(notionCache).length});
    }
}

function saveNotionCache() {
    localStorage.setItem(NOTION_CACHE_KEY, JSON.stringify(notionCache));
}

function reformatDatabaseId() {
    const input = document.getElementById('notionDatabaseId');
    const format = document.getElementById('dbIdFormat').value;
    let id = input.value.replace(/-/g, ''); // Remove all dashes
    
    if (format === 'dash' && id.length === 32) {
        // Add dashes in UUID format: 8-4-4-4-12
        id = id.substring(0, 8) + '-' + 
            id.substring(8, 12) + '-' + 
            id.substring(12, 16) + '-' + 
            id.substring(16, 20) + '-' + 
            id.substring(20);
    }
    
    input.value = id;
    debugLog('Reformatted database ID', {format, id});
}

function saveNotionConfig() {
    const apiKey = document.getElementById('notionApiKey').value.trim();
    const databaseId = document.getElementById('notionDatabaseId').value.trim();
    
    if (!apiKey || !databaseId) {
        showNotionStatus('Please enter both API key and database ID', 'error');
        return;
    }
    
    notionConfig = { apiKey, databaseId };
    localStorage.setItem(NOTION_CONFIG_KEY, JSON.stringify(notionConfig));
    
    showNotionStatus('Configuration saved! Starting sync...', 'success');
    debugLog('Notion config saved and starting sync');
    
    startNotionSync();
    syncFromNotion();
}

async function testNotionConnection() {
    const apiKey = document.getElementById('notionApiKey').value.trim();
    const databaseId = document.getElementById('notionDatabaseId').value.trim();
    
    if (!apiKey || !databaseId) {
        showNotionStatus('Please enter both API key and database ID', 'error');
        return;
    }
    
    showNotionStatus('Testing connection...', 'info');
    debugLog('Testing Notion connection', {databaseId});
    
    try {
        const response = await fetch(`https://api.notion.com/v1/databases/${databaseId}/query`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Notion-Version': '2022-06-28',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                page_size: 1
            })
        });
        
        debugLog('Response status: ' + response.status);
        
        const data = await response.json();
        debugLog('Response data', data);
        
        if (!response.ok) {
            let errorMsg = data.message || data.code || 'Connection failed';
            
            // Add helpful context for common errors
            if (response.status === 404 || data.code === 'object_not_found') {
                errorMsg = 'Database not found. Check the Database ID or try with/without dashes.';
            } else if (response.status === 401 || data.code === 'unauthorized') {
                errorMsg = 'Unauthorized. Make sure the database is shared with your integration.';
            } else if (response.status === 400 || data.code === 'invalid_request') {
                errorMsg = 'Invalid request. Check your API key for typos.';
            }
            
            throw new Error(errorMsg);
        }
        
        showNotionStatus('‚úì Connection successful! Found database. Click "Save & Start Sync" to begin.', 'success');
        debugLog('Connection test successful');
    } catch (error) {
        const errorMsg = error.message || 'Unknown error';
        showNotionStatus(`‚úó Connection failed: ${errorMsg}`, 'error');
        debugLog('Connection test failed: ' + errorMsg, error);
    }
}

function showNotionStatus(message, type) {
    const container = document.getElementById('notionStatus');
    container.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
}

function startNotionSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
    }
    
    syncInterval = setInterval(() => {
        syncFromNotion();
    }, 30000);
    
    updateSyncStatus('Connected', false);
    debugLog('Auto-sync started (30s interval)');
}

function updateSyncStatus(message, isError) {
    const dots = document.querySelectorAll('.sync-dot');
    const statuses = document.querySelectorAll('[id^="syncStatus"]');
    
    dots.forEach(dot => {
        dot.classList.remove('inactive');
        if (isError) {
            dot.classList.add('error');
        } else {
            dot.classList.remove('error');
        }
    });
    
    statuses.forEach(status => {
        status.textContent = message;
    });
}

async function syncFromNotion() {
    if (!notionConfig || !notionConfig.apiKey || !notionConfig.databaseId) {
        debugLog('Cannot sync: No Notion config');
        return;
    }
    
    try {
        updateSyncStatus('Syncing...', false);
        debugLog('Starting Notion sync...');
        
        const response = await fetch(`https://api.notion.com/v1/databases/${notionConfig.databaseId}/query`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${notionConfig.apiKey}`,
                'Notion-Version': '2022-06-28',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                page_size: 100
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            let errorMsg = error.message || error.code || 'API error';
            
            // Add helpful context
            if (response.status === 404 || error.code === 'object_not_found') {
                errorMsg = 'Database not found. Check Database ID in settings.';
            } else if (response.status === 401 || error.code === 'unauthorized') {
                errorMsg = 'Unauthorized. Make sure database is shared with integration.';
            }
            
            throw new Error(errorMsg);
        }
        
        const data = await response.json();
        debugLog('Sync response received', {results: data.results.length});
        
        // Update samples
        const newSamples = [];
        const newCache = {};
        
        data.results.forEach(page => {
            const props = page.properties;
            
            // Get Injection ID
            let injectionId = '';
            if (props['Injection ID'] && props['Injection ID'].title && props['Injection ID'].title[0]) {
                injectionId = props['Injection ID'].title[0].plain_text;
            }
            
            if (!injectionId) return;
            
            // Get other properties
            let description = '';
            if (props['Experiment Description - Manual'] && props['Experiment Description - Manual'].rich_text && props['Experiment Description - Manual'].rich_text[0]) {
                description = props['Experiment Description - Manual'].rich_text[0].plain_text;
            }
            
            let location = '';
            if (props['Location'] && props['Location'].rich_text && props['Location'].rich_text[0]) {
                location = props['Location'].rich_text[0].plain_text;
            }
            
            let reserved = 'Available';
            if (props['Reserved'] && props['Reserved'].multi_select && props['Reserved'].multi_select[0]) {
                reserved = props['Reserved'].multi_select[0].name;
            }
            
            let sectioningDate = '';
            if (props['date:Sectioning Date:start'] && props['date:Sectioning Date:start'].date) {
                sectioningDate = props['date:Sectioning Date:start'].date.start;
            }
            
            // Get Pick List
            let pickList = [];
            if (props['Pick List'] && props['Pick List'].multi_select) {
                pickList = props['Pick List'].multi_select.map(item => item.name);
            }
            
            // Create sample object
            const sample = {
                injectionId,
                experimentDescription: description,
                reservedStatus: reserved,
                location,
                sectioningDate,
                status: 'in_place',
                checkedOutBy: null,
                checkedOutTime: null
            };
            
            newSamples.push(sample);
            newCache[injectionId] = {
                pickList,
                lastSynced: new Date().toISOString()
            };
        });
        
        samples = newSamples;
        notionCache = newCache;
        
        saveSamples();
        saveNotionCache();
        
        lastSyncTime = new Date();
        updateSyncStatus(`Last sync: ${lastSyncTime.toLocaleTimeString()}`, false);
        
        debugLog('Sync completed successfully', {
            samples: samples.length,
            cached: Object.keys(notionCache).length
        });
        
        renderView();
        
    } catch (error) {
        console.error('Notion sync error:', error);
        debugLog('Sync error: ' + error.message, error);
        updateSyncStatus('Sync failed: ' + error.message, true);
    }
}

function getSamplePickList(injectionId) {
    if (notionCache[injectionId]) {
        return notionCache[injectionId].pickList || [];
    }
    return [];
}

function isMyPick(sample) {
    const pickList = getSamplePickList(sample.injectionId);
    return pickList.includes(currentUser);
}

function isTeamPick(sample) {
    const pickList = getSamplePickList(sample.injectionId);
    return pickList.length > 0 && !pickList.includes(currentUser);
}

function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    const btnId = 'filter' + filter.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('') + (currentView === 'search' ? '' : '2');
    document.getElementById(btnId)?.classList.add('active');
    renderView();
}

function getFilteredSamples() {
    if (currentFilter === 'my-picks') {
        return samples.filter(s => isMyPick(s));
    } else if (currentFilter === 'team-picks') {
        return samples.filter(s => isTeamPick(s));
    }
    return samples;
}

function parseLocation(loc) {
    if (!loc) return null;
    const match = loc.match(/S(\d+)-R(\d+)-D(\d+)-C(\d+)-P(\d+)/);
    if (!match) return null;
    return {
        shelf: parseInt(match[1]),
        rack: parseInt(match[2]),
        drawer: parseInt(match[3]),
        compartment: parseInt(match[4]),
        position: parseInt(match[5])
    };
}

function groupSamplesByLocation() {
    const grouped = {shelves: {}};
    const filtered = getFilteredSamples();
    
    filtered.forEach(sample => {
        const loc = parseLocation(sample.location);
        if (!loc) return;
        if (!grouped.shelves[loc.shelf]) grouped.shelves[loc.shelf] = {racks: {}};
        if (!grouped.shelves[loc.shelf].racks[loc.rack]) grouped.shelves[loc.shelf].racks[loc.rack] = {drawers: {}};
        if (!grouped.shelves[loc.shelf].racks[loc.rack].drawers[loc.drawer]) grouped.shelves[loc.shelf].racks[loc.rack].drawers[loc.drawer] = {compartments: {}};
        if (!grouped.shelves[loc.shelf].racks[loc.rack].drawers[loc.drawer].compartments[loc.compartment]) grouped.shelves[loc.shelf].racks[loc.rack].drawers[loc.drawer].compartments[loc.compartment] = {positions: {}};
        grouped.shelves[loc.shelf].racks[loc.rack].drawers[loc.drawer].compartments[loc.compartment].positions[loc.position] = sample;
    });
    
    return grouped;
}

function countSamplesInRack(rack) {
    let count = 0;
    Object.values(rack.drawers || {}).forEach(drawer => {
        count += countSamplesInDrawer(drawer);
    });
    return count;
}

function countSamplesInDrawer(drawer) {
    let count = 0;
    Object.values(drawer.compartments || {}).forEach(compartment => {
        count += Object.keys(compartment.positions || {}).length;
    });
    return count;
}

function selectShelf(shelfNum) {
    selectedShelf = shelfNum;
    selectedRack = null;
    selectedDrawer = null;
    renderBrowseView();
}

function selectRack(rackNum) {
    selectedRack = rackNum;
    selectedDrawer = null;
    renderBrowseView();
}

function selectDrawer(drawerNum) {
    selectedDrawer = drawerNum;
    renderBrowseView();
}

function showView(view) {
    currentView = view;
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('searchView').classList.add('hidden');
    document.getElementById('browseView').classList.add('hidden');
    document.getElementById('detailView').classList.add('hidden');
    document.getElementById('adminView').classList.add('hidden');
    document.getElementById(view + 'View').classList.remove('hidden');
    if (view === 'browse') {
        selectedShelf = null;
        selectedRack = null;
        selectedDrawer = null;
    }
    renderView();
}

function renderView() {
    if (currentView === 'search') {
        filterSamples();
    } else if (currentView === 'browse') {
        renderBrowseView();
    } else if (currentView === 'admin') {
        renderAdminView();
    }
    updateFooter();
}

function renderBrowseView() {
    const grouped = groupSamplesByLocation();
    if (!selectedShelf) {
        renderShelfSelector(grouped);
    } else if (!selectedRack) {
        renderRackView(grouped);
    } else if (!selectedDrawer) {
        renderDrawerView(grouped);
    } else {
        renderCompartmentView(grouped);
    }
}

function renderShelfSelector(grouped) {
    document.getElementById('shelfSelector').classList.remove('hidden');
    document.getElementById('rackView').classList.add('hidden');
    document.getElementById('drawerView').classList.add('hidden');
    document.getElementById('compartmentView').classList.add('hidden');
    const container = document.getElementById('shelfSelector');
    const html = [1, 2, 3, 4].map(shelfNum => {
        const shelf = grouped.shelves[shelfNum];
        const count = shelf ? Object.keys(shelf.racks).reduce((sum, rackNum) => {
            return sum + countSamplesInRack(shelf.racks[rackNum]);
        }, 0) : 0;
        return `<div class="shelf-btn" onclick="selectShelf(${shelfNum})"><div class="shelf-label">Shelf ${shelfNum}</div><div class="shelf-count">${count} samples</div></div>`;
    }).join('');
    container.innerHTML = html;
}

function renderRackView(grouped) {
    document.getElementById('shelfSelector').classList.add('hidden');
    document.getElementById('rackView').classList.remove('hidden');
    document.getElementById('drawerView').classList.add('hidden');
    document.getElementById('compartmentView').classList.add('hidden');
    const container = document.getElementById('rackView');
    const shelf = grouped.shelves[selectedShelf] || {racks: {}};
    const breadcrumb = `<div class="breadcrumb"><span class="breadcrumb-link" onclick="selectShelf(null)">Shelves</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-item">Shelf ${selectedShelf}</span></div>`;
    const racksHtml = [1, 2, 3, 4, 5, 6, 7, 8].map(rackNum => {
        const count = shelf.racks[rackNum] ? countSamplesInRack(shelf.racks[rackNum]) : 0;
        return `<div class="rack-card" onclick="selectRack(${rackNum})"><div class="rack-number">R${rackNum}</div><div class="rack-samples">${count}/50 slots</div></div>`;
    }).join('');
    container.innerHTML = `${breadcrumb}<div class="rack-view"><h3 style="margin-bottom: 8px;">Select a Rack</h3><div class="rack-grid">${racksHtml}</div></div>`;
}

function renderDrawerView(grouped) {
    document.getElementById('shelfSelector').classList.add('hidden');
    document.getElementById('rackView').classList.add('hidden');
    document.getElementById('drawerView').classList.remove('hidden');
    document.getElementById('compartmentView').classList.add('hidden');
    const container = document.getElementById('drawerView');
    const rack = grouped.shelves[selectedShelf]?.racks[selectedRack] || {drawers: {}};
    const breadcrumb = `<div class="breadcrumb"><span class="breadcrumb-link" onclick="selectShelf(null)">Shelves</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-link" onclick="selectRack(null)">Shelf ${selectedShelf}</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-item">Rack ${selectedRack}</span></div>`;
    const drawersHtml = [1, 2, 3, 4, 5].map(drawerNum => {
        const count = rack.drawers[drawerNum] ? countSamplesInDrawer(rack.drawers[drawerNum]) : 0;
        return `<div class="drawer-row" onclick="selectDrawer(${drawerNum})"><div class="drawer-label">Drawer ${drawerNum}</div><div class="drawer-count">${count}/10 slots</div></div>`;
    }).join('');
    container.innerHTML = `${breadcrumb}<div class="drawer-view"><h3 style="margin-bottom: 8px;">Select a Drawer</h3><div class="drawer-stack">${drawersHtml}</div></div>`;
}

function renderCompartmentView(grouped) {
    document.getElementById('shelfSelector').classList.add('hidden');
    document.getElementById('rackView').classList.add('hidden');
    document.getElementById('drawerView').classList.add('hidden');
    document.getElementById('compartmentView').classList.remove('hidden');
    const container = document.getElementById('compartmentView');
    const drawer = grouped.shelves[selectedShelf]?.racks[selectedRack]?.drawers[selectedDrawer] || {compartments: {}};
    const breadcrumb = `<div class="breadcrumb"><span class="breadcrumb-link" onclick="selectShelf(null)">Shelves</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-link" onclick="selectRack(null)">Shelf ${selectedShelf}</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-link" onclick="selectDrawer(null)">Rack ${selectedRack}</span><span class="breadcrumb-separator">‚Ä∫</span><span class="breadcrumb-item">Drawer ${selectedDrawer}</span></div>`;
    const compartmentsHtml = [1, 2, 3, 4, 5].map(compNum => {
        const compartment = drawer.compartments[compNum] || {positions: {}};
        const pos1 = compartment.positions[1];
        const pos2 = compartment.positions[2];
        
        function getSlotClass(sample) {
            if (!sample) return '';
            if (isMyPick(sample)) return 'my-pick';
            if (isTeamPick(sample)) return 'team-pick';
            if (sample.status === 'checked_out') return 'checked-out';
            if (sample.reservedStatus !== 'Available') return 'reserved';
            return 'filled';
        }
        
        function getSlotLabel(sample, posNum) {
            if (!sample) return `P${posNum}`;
            return sample.injectionId;
        }
        
        return `<div class="compartment-box"><div class="compartment-label">C${compNum}</div><div class="position-slot ${pos1 ? 'filled ' + getSlotClass(pos1) : ''}" onclick="${pos1 ? `showDetail('${pos1.injectionId}')` : 'return false'}">${getSlotLabel(pos1, 1)}</div><div class="position-slot ${pos2 ? 'filled ' + getSlotClass(pos2) : ''}" onclick="${pos2 ? `showDetail('${pos2.injectionId}')` : 'return false'}">${getSlotLabel(pos2, 2)}</div></div>`;
    }).join('');
    container.innerHTML = `${breadcrumb}<div class="compartment-view"><h3>S${selectedShelf}-R${selectedRack}-D${selectedDrawer}</h3><p style="font-size: 12px; color: #6b7280; margin: 8px 0 16px 0;">üü° Your picks | üîµ Team picks | üü¢ Available</p><div class="compartment-grid">${compartmentsHtml}</div></div>`;
}

function filterSamples() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const filtered = getFilteredSamples().filter(s =>
        query === '' ||
        s.injectionId.toLowerCase().includes(query) ||
        (s.experimentDescription && s.experimentDescription.toLowerCase().includes(query))
    );
    
    const container = document.getElementById('searchResults');
    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><h2>No samples found</h2><p>Try a different search or filter</p></div>';
    } else {
        container.innerHTML = filtered.slice(0, 100).map(s => renderSampleCard(s)).join('');
    }
}

function renderSampleCard(sample) {
    const statusClass = sample.status === 'checked_out' ? 'status-checked-out' : 'status-in-place';
    const reservedBadge = sample.reservedStatus !== 'Available' ? `<span class="badge badge-reserved">${sample.reservedStatus}</span>` : '';
    
    const pickList = getSamplePickList(sample.injectionId);
    const pickBadge = pickList.length > 0 ? `<span class="badge badge-pick">üìå ${pickList.join(', ')}</span>` : '';
    
    let cardClass = 'sample-card';
    if (isMyPick(sample)) cardClass += ' my-pick';
    else if (isTeamPick(sample)) cardClass += ' team-pick';
    
    return `<div class="${cardClass}" onclick="showDetail('${sample.injectionId}')"><div class="sample-header"><div class="sample-id">${sample.injectionId}</div><div class="status-dot ${statusClass}"></div></div>${sample.experimentDescription ? `<div class="sample-description">${sample.experimentDescription}</div>` : ''}<div><span class="sample-location">${sample.location || 'No location'}</span>${reservedBadge}${pickBadge}</div></div>`;
}

function showDetail(injectionId) {
    const sample = samples.find(s => s.injectionId === injectionId);
    if (!sample) return;
    currentView = 'detail';
    document.getElementById('searchView').classList.add('hidden');
    document.getElementById('browseView').classList.add('hidden');
    document.getElementById('adminView').classList.add('hidden');
    const container = document.getElementById('detailView');
    container.classList.remove('hidden');
    
    const pickList = getSamplePickList(sample.injectionId);
    const pickBadge = pickList.length > 0 ? `<div class="info-section"><div class="info-label">Pick List</div><div><span class="badge badge-pick">üìå ${pickList.join(', ')}</span></div></div>` : '';
    
    const statusBadge = sample.status === 'in_place' ? '<span style="background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:4px;font-size:12px;">In Place</span>' : '<span style="background:#fef3c7;color:#92400e;padding:4px 8px;border-radius:4px;font-size:12px;">Checked Out</span>';
    const reservedBadge = sample.reservedStatus === 'Available' ? '<span style="background:#d1fae5;color:#065f46;padding:4px 8px;border-radius:4px;font-size:12px;">Available</span>' : `<span class="badge-reserved">${sample.reservedStatus}</span>`;
    
    container.innerHTML = `<div class="detail-view"><a class="back-btn" onclick="showView('search')">‚Üê Back</a><div class="detail-grid"><div><h2 style="font-size:32px;margin-bottom:24px;">${sample.injectionId}</h2><div class="info-section"><div class="info-label">Experiment</div><div class="info-value">${sample.experimentDescription || 'No description'}</div></div>${pickBadge}<div class="info-section"><div class="info-label">Reserved Status</div><div>${reservedBadge}</div></div><div class="info-section"><div class="info-label">Sectioning Date</div><div class="info-value">${sample.sectioningDate || 'Not recorded'}</div></div><div class="info-section"><div class="info-label">Status</div><div>${statusBadge}</div></div></div><div><div class="location-box"><h3 style="margin-bottom:16px;">Location</h3><div class="location-display">${sample.location || 'Not Assigned'}</div></div><div>${sample.status === 'in_place' ? `<h3 style="margin-bottom:8px;">Check Out</h3><input type="text" id="checkoutName" placeholder="Your name" value="${currentUser}"><button class="btn btn-warning" onclick="checkOut('${sample.injectionId}')">Check Out</button>` : `<button class="btn btn-success" onclick="checkIn('${sample.injectionId}')">Check In</button>`}</div></div></div></div>`;
}

function checkOut(injectionId) {
    const name = document.getElementById('checkoutName').value.trim();
    if (!name) {
        alert('Please enter your name');
        return;
    }
    const sample = samples.find(s => s.injectionId === injectionId);
    sample.status = 'checked_out';
    sample.checkedOutBy = name;
    sample.checkedOutTime = new Date().toISOString();
    saveSamples();
    showDetail(injectionId);
}

function checkIn(injectionId) {
    const sample = samples.find(s => s.injectionId === injectionId);
    sample.status = 'in_place';
    sample.checkedOutBy = null;
    sample.checkedOutTime = null;
    saveSamples();
    showDetail(injectionId);
}

function renderAdminView() {
    const totalSamples = samples.length;
    const myPicks = samples.filter(s => isMyPick(s)).length;
    const teamPicks = samples.filter(s => isTeamPick(s)).length;
    const inPlace = samples.filter(s => s.status === 'in_place').length;
    const checkedOut = samples.filter(s => s.status === 'checked_out').length;
    
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card"><div class="stat-number">${totalSamples}</div><div class="stat-label">Total Samples</div></div>
        <div class="stat-card"><div class="stat-number" style="color:#fbbf24;">${myPicks}</div><div class="stat-label">My Picks</div></div>
        <div class="stat-card"><div class="stat-number" style="color:#60a5fa;">${teamPicks}</div><div class="stat-label">Team Picks</div></div>
        <div class="stat-card"><div class="stat-number" style="color:#10b981;">${inPlace}</div><div class="stat-label">In Place</div></div>
        <div class="stat-card"><div class="stat-number" style="color:#f59e0b;">${checkedOut}</div><div class="stat-label">Checked Out</div></div>
    `;
}

function exportData() {
    const dataStr = JSON.stringify({samples, notionCache}, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `e11-samples-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    debugLog('Data exported');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (imported.samples && Array.isArray(imported.samples)) {
                samples = imported.samples;
                if (imported.notionCache) {
                    notionCache = imported.notionCache;
                    saveNotionCache();
                }
                saveSamples();
                alert(`Successfully imported ${samples.length} samples!`);
                debugLog('Data imported', {samples: samples.length});
                renderView();
            } else {
                alert('Invalid file format');
            }
        } catch (error) {
            alert('Error reading file: ' + error.message);
            debugLog('Import error', error);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function clearAllData() {
    if (!confirm('‚ö†Ô∏è Clear ALL data?\n\nThis will delete:\n‚Ä¢ All samples\n‚Ä¢ Notion cache\n\nThis CANNOT be undone!')) {
        return;
    }
    
    try {
        samples = [];
        notionCache = {};
        
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(NOTION_CACHE_KEY);
        
        debugLog('All data cleared');
        
        alert('‚úì All data cleared! Page will reload.');
        window.location.reload();
    } catch (error) {
        alert('Error clearing data: ' + error.message);
        debugLog('Clear error', error);
    }
}

function updateFooter() {
    const myPicks = samples.filter(s => isMyPick(s)).length;
    document.getElementById('footerStats').textContent = `${samples.length} samples${myPicks > 0 ? ' | ' + myPicks + ' in your picks' : ''}`;
}

window.onload = init;
    </script>
</body>
</html>
