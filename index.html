<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E11 Sample Tracker</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a5fb4, #3584e4);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .header-info {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .sync-bar {
            background: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .sync-dot.synced { background: #2ec27e; }
        .sync-dot.syncing { background: #f6d32d; animation: pulse 1s infinite; }
        .sync-dot.error { background: #e01b24; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .user-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .user-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-btn:hover { border-color: #3584e4; }
        .user-btn.active {
            background: #3584e4;
            border-color: #3584e4;
            color: white;
        }
        
        .filters {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #f0f0f0;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .filter-btn:hover { background: #e0e0e0; }
        .filter-btn.active {
            background: #3584e4;
            color: white;
        }
        
        .search-bar {
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-bar input:focus {
            border-color: #3584e4;
        }
        
        .content {
            padding: 16px 20px;
        }
        
        .sample-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }
        
        .sample-card.my-pick {
            border-left-color: #f6d32d;
            background: linear-gradient(135deg, #fffaeb 0%, #fff 50%);
            box-shadow: 0 2px 8px rgba(246, 211, 45, 0.3);
        }
        
        .sample-card.team-pick {
            border-left-color: #3584e4;
            background: linear-gradient(135deg, #e8f4ff 0%, #fff 50%);
        }
        
        .sample-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .sample-id {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        .sample-id .star {
            color: #f6d32d;
            margin-left: 4px;
        }
        
        .pick-badge {
            background: #ffeeba;
            color: #856404;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .pick-badge.team {
            background: #cce5ff;
            color: #004085;
        }
        
        .sample-location {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 15px;
            color: #3584e4;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .sample-description {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .stats-bar {
            background: #f8f9fa;
            padding: 10px 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #3584e4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß¨ E11 Sample Tracker</h1>
        <div class="header-info">
            <span id="currentUser">Select your name below</span>
        </div>
    </div>
    
    <div class="sync-bar">
        <div class="sync-status">
            <div class="sync-dot" id="syncDot"></div>
            <span id="syncStatus">Loading...</span>
        </div>
        <button onclick="refreshData()" style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 6px; background: white; cursor: pointer;">
            üîÑ Refresh
        </button>
    </div>
    
    <div class="user-selector" id="userSelector">
        <!-- Users will be populated here -->
    </div>
    
    <div class="filters">
        <button class="filter-btn active" data-filter="all">All Samples</button>
        <button class="filter-btn" data-filter="my-picks">‚≠ê My Picks</button>
        <button class="filter-btn" data-filter="team-picks">üë• Team Picks</button>
        <button class="filter-btn" data-filter="available">Available</button>
    </div>
    
    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="üîç Search by Injection ID or location...">
    </div>
    
    <div class="content" id="sampleList">
        <!-- Samples will be rendered here -->
    </div>
    
    <div class="stats-bar" id="statsBar">
        Loading sample data...
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="margin-top: 16px; color: #666;">Loading samples...</p>
    </div>
    
    <script>
        // Configuration
        const USERS = ['Amanda', 'Jules', 'Michelle', 'Kathleen', 'Jeff', 'Hugo', 'Stephanie', 'Clarence', 'JinYoung'];
        const SAMPLE_DATA_URL = 'samples-organized.json';
        const PICK_LIST_URL = 'data/pick-list.json';
        
        // State
        let samples = [];
        let pickLists = {};
        let sampleInfo = {};
        let currentUser = localStorage.getItem('e11-user') || null;
        let currentFilter = 'all';
        let searchQuery = '';
        let lastSync = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initUserSelector();
            initFilters();
            initSearch();
            loadData();
        });
        
        function initUserSelector() {
            const container = document.getElementById('userSelector');
            USERS.forEach(user => {
                const btn = document.createElement('button');
                btn.className = 'user-btn' + (currentUser === user ? ' active' : '');
                btn.textContent = user;
                btn.onclick = () => selectUser(user);
                container.appendChild(btn);
            });
            updateUserDisplay();
        }
        
        function selectUser(user) {
            currentUser = user;
            localStorage.setItem('e11-user', user);
            
            document.querySelectorAll('.user-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === user);
            });
            
            updateUserDisplay();
            renderSamples();
        }
        
        function updateUserDisplay() {
            document.getElementById('currentUser').textContent = 
                currentUser ? `Welcome, ${currentUser}` : 'Select your name below';
        }
        
        function initFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderSamples();
                };
            });
        }
        
        function initSearch() {
            const input = document.getElementById('searchInput');
            input.addEventListener('input', (e) => {
                searchQuery = e.target.value.toLowerCase();
                renderSamples();
            });
        }
        
        async function loadData() {
            showLoading(true);
            updateSyncStatus('syncing', 'Loading...');
            
            try {
                // Load sample location data
                const sampleResponse = await fetch(SAMPLE_DATA_URL);
                if (sampleResponse.ok) {
                    const sampleData = await sampleResponse.json();
                    samples = sampleData.samples || [];
                    console.log(`Loaded ${samples.length} samples`);
                }
            } catch (e) {
                console.warn('Could not load sample data:', e);
            }
            
            try {
                // Load pick list from GitHub (synced from Notion)
                const pickResponse = await fetch(PICK_LIST_URL + '?t=' + Date.now());
                if (pickResponse.ok) {
                    const pickData = await pickResponse.json();
                    pickLists = pickData.picks || {};
                    sampleInfo = pickData.sampleInfo || {};
                    lastSync = pickData.lastSync;
                    console.log(`Loaded ${Object.keys(pickLists).length} pick lists`);
                }
            } catch (e) {
                console.warn('Could not load pick list:', e);
            }
            
            showLoading(false);
            updateSyncStatus('synced', lastSync ? `Last sync: ${formatTime(lastSync)}` : 'Pick list not loaded');
            updateStats();
            renderSamples();
        }
        
        function refreshData() {
            loadData();
        }
        
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        function updateSyncStatus(status, text) {
            const dot = document.getElementById('syncDot');
            dot.className = 'sync-dot ' + status;
            document.getElementById('syncStatus').textContent = text;
        }
        
        function updateStats() {
            const myPicks = currentUser ? 
                Object.values(pickLists).filter(p => p.includes(currentUser)).length : 0;
            const teamPicks = Object.keys(pickLists).length;
            
            document.getElementById('statsBar').textContent = 
                `${samples.length} samples ‚Ä¢ ${teamPicks} with picks` +
                (currentUser ? ` ‚Ä¢ ${myPicks} for ${currentUser}` : '');
        }
        
        function getSamplePicks(injectionId) {
            return pickLists[injectionId] || [];
        }
        
        function isMyPick(injectionId) {
            if (!currentUser) return false;
            return getSamplePicks(injectionId).includes(currentUser);
        }
        
        function isTeamPick(injectionId) {
            const picks = getSamplePicks(injectionId);
            return picks.length > 0 && !isMyPick(injectionId);
        }
        
        function filterSamples() {
            return samples.filter(sample => {
                // Apply filter
                if (currentFilter === 'my-picks' && !isMyPick(sample.injectionId)) return false;
                if (currentFilter === 'team-picks' && !isTeamPick(sample.injectionId)) return false;
                if (currentFilter === 'available' && getSamplePicks(sample.injectionId).length > 0) return false;
                
                // Apply search
                if (searchQuery) {
                    const searchFields = [
                        sample.injectionId,
                        sample.location,
                        sample.experimentDescription
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchQuery)) return false;
                }
                
                return true;
            });
        }
        
        function renderSamples() {
            const container = document.getElementById('sampleList');
            const filtered = filterSamples();
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üî¨</div>
                        <h3>No samples found</h3>
                        <p>Try adjusting your filters or search</p>
                    </div>
                `;
                return;
            }
            
            // Sort: my picks first, then team picks, then by location
            filtered.sort((a, b) => {
                const aMyPick = isMyPick(a.injectionId);
                const bMyPick = isMyPick(b.injectionId);
                const aTeamPick = isTeamPick(a.injectionId);
                const bTeamPick = isTeamPick(b.injectionId);
                
                if (aMyPick && !bMyPick) return -1;
                if (!aMyPick && bMyPick) return 1;
                if (aTeamPick && !bTeamPick) return -1;
                if (!aTeamPick && bTeamPick) return 1;
                
                return (a.location || '').localeCompare(b.location || '');
            });
            
            container.innerHTML = filtered.slice(0, 100).map(sample => {
                const picks = getSamplePicks(sample.injectionId);
                const myPick = isMyPick(sample.injectionId);
                const teamPick = isTeamPick(sample.injectionId);
                
                let cardClass = 'sample-card';
                if (myPick) cardClass += ' my-pick';
                else if (teamPick) cardClass += ' team-pick';
                
                let pickBadge = '';
                if (picks.length > 0) {
                    const badgeClass = myPick ? 'pick-badge' : 'pick-badge team';
                    pickBadge = `<span class="${badgeClass}">üìå ${picks.join(', ')}</span>`;
                }
                
                return `
                    <div class="${cardClass}">
                        <div class="sample-header">
                            <span class="sample-id">
                                ${sample.injectionId}
                                ${myPick ? '<span class="star">‚≠ê</span>' : ''}
                            </span>
                            ${pickBadge}
                        </div>
                        <div class="sample-location">${sample.location || 'No location assigned'}</div>
                        <div class="sample-description">${sample.experimentDescription || ''}</div>
                    </div>
                `;
            }).join('');
            
            updateStats();
        }
    </script>
</body>
</html>
